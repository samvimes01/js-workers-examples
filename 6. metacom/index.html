<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width" />
    <title>Channel messaging demo</title>
    <link
      href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300|Lobster+Two"
      rel="stylesheet"
      type="text/css"
    />
  </head>
  <body>
    <h1>Channel messaging demo</h1>
    <p id="auth-status">Not logged in</p>
    <p id="message-output">Message not yet sent</p>

    <form>
      <button>Get counter</button>
    </form>
    <script type="importmap">
      {
        "imports": {
          "metautil": "/metautil.mjs"
        }
      }
    </script>
    <script type="module">
      const output = document.getElementById("message-output");
      const button = document.querySelector("button");
      const authStatus = document.getElementById("auth-status");

      import { Metacom } from "/metacom.mjs";

      const sw = navigator.serviceWorker;
      sw.register("/metacom-service-worker.js");
      try {
        const url = "ws://localhost:8002/api";
        const metacom = await Metacom.createProxy(url, {
          metacomLoad: ["auth", "console", "example", "files"],
        });
        const api = metacom.api;

        const token = localStorage.getItem("metarhia.session.token");
        let logged = false;
        if (token) {
          const res = await api.auth.restore({ token });
          logged = res.status === "logged";
          updateAuthStatus();
        }
        if (!logged) {
          const res = await api.auth.signin({
            login: "marcus",
            password: "marcus",
          });
          if (res.token) {
            localStorage.setItem("metarhia.session.token", res.token);
            logged = true;
            updateAuthStatus();
          }
        }

        button.addEventListener("click", async (e) => {
          e.preventDefault();
          const packet = await metacom.api.example.counter();
          output.innerHTML = packet.result;
        });

        function updateAuthStatus() {
          setTimeout(() => {
            authStatus.innerHTML = logged ? "Logged in" : "Not logged in";
          }, 1000);
        }
      } catch (error) {
        console.error("Metacom initialization error:", error);
      }
    </script>
  </body>
</html>
